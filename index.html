<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTIMATE MONITOR | TriDuc Media</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1a1a1a;
            --accent-color: #00ff88;
            --danger-color: #ff4444;
        }

        body { 
            background: var(--bg-color); margin: 0; color: #fff; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* HEADER */
        header { 
            padding: 0 10px; height: 45px; background: var(--panel-color); 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 2px solid var(--accent-color);
            z-index: 100;
        }

        .controls-group { display: flex; gap: 8px; align-items: center; }

        /* BUTTONS & SELECTS */
        button, select { 
            cursor: pointer; padding: 5px 10px; background: #333; color: #fff; 
            border: 1px solid #555; border-radius: 4px; font-size: 11px; outline: none;
        }
        button:hover, select:hover { border-color: var(--accent-color); background: #444; }
        button.active { background: var(--accent-color); color: #000; font-weight: bold; }

        /* MENU LỌC CAMERA (MODAL) */
        #filter-modal {
            position: absolute; top: 50px; left: 10px;
            background: rgba(20, 20, 20, 0.95); border: 1px solid #555;
            padding: 10px; border-radius: 5px; z-index: 200;
            display: none; width: 200px; max-height: 80vh; overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        .filter-item { display: block; margin-bottom: 5px; font-size: 12px; cursor: pointer; }
        .filter-item input { margin-right: 8px; accent-color: var(--accent-color); }

        /* GRID */
        #video-grid { 
            flex-grow: 1; display: grid; gap: 2px; padding: 2px; background: #000;
            overflow: hidden;
        }
        .layout-2x2 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
        .layout-3x3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
        .layout-4x4 { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); }

        /* CAMERA BOX */
        .cam-box { 
            position: relative; background: #000; border: 1px solid #333; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        video { width: 100%; height: 100%; object-fit: contain; }

        /* OVERLAYS */
        .cam-label { 
            position: absolute; top: 0; left: 0; 
            background: rgba(0,0,0,0.6); padding: 2px 6px; 
            font-size: 11px; color: var(--accent-color); font-weight: bold; 
            z-index: 5; pointer-events: none;
        }

        /* Error Screen (Khi luồng chết) */
        .error-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        .error-text { color: var(--danger-color); font-size: 12px; margin-bottom: 10px; text-align: center;}
        .btn-retry { background: var(--accent-color); color: #000; font-weight: bold; border: none; }

    </style>
</head>
<body>

    <header>
        <div class="controls-group">
            <strong style="color:var(--accent-color);">TRIDUC</strong>
            
            <button onclick="toggleFilterMenu()" id="btn-filter"><i class="fas fa-list"></i> Chọn Cam</button>
            
            <select id="quality-select" onchange="changeQuality(this.value)">
                <option value="-1">⚡ Auto (Best)</option>
                <option value="1080">Full HD 1080p</option>
                <option value="720">HD 720p</option>
                <option value="480">SD 480p (Nhanh)</option>
            </select>
        </div>

        <div class="controls-group">
            <button onclick="setLayout(4)" id="btn-2x2">2x2</button>
            <button onclick="setLayout(9)" id="btn-3x3">3x3</button>
            <button onclick="setLayout(16)" id="btn-4x4" class="active">4x4</button>
            <button onclick="location.reload()"><i class="fas fa-sync"></i></button>
        </div>
    </header>

    <div id="filter-modal">
        <div style="margin-bottom:10px; font-weight:bold; border-bottom:1px solid #444; padding-bottom:5px;">DANH SÁCH HIỂN THỊ</div>
        <div id="checklist-container"></div>
    </div>

    <div id="video-grid" class="layout-4x4"></div>

    <script>
        // === CẤU HÌNH ===
        // Lưu ý: Nếu dùng GitHub Pages thì KHÔNG xem được HTTP. Phải chạy local hoặc cấu hình SSL.
        const SERVER_HOST = 'http://triducmedia.ddns.net:5003';
        
        const MASTER_LIST = [
            'source', 'source1', 'source2', 'source3', 'source4', 'source5',
            'studio1', 'studio2',
            'laptop1', 'laptop2', 'laptop3', 'laptop4', 'laptop5', 
            'laptop6', 'laptop7', 'laptop8', 'laptop9', 'laptop10'
        ];

        // Mặc định hiển thị tất cả
        let activeStreams = [...MASTER_LIST];
        let hlsInstances = {}; // Quản lý bộ nhớ HLS
        let retryCounts = {};  // Đếm số lần lỗi của từng cam
        let currentLayout = 16;
        let preferredHeight = -1; // -1 là Auto

        document.addEventListener("DOMContentLoaded", () => {
            initFilterMenu();
            renderGrid();
        });

        // 1. TẠO MENU LỌC
        function initFilterMenu() {
            const container = document.getElementById('checklist-container');
            MASTER_LIST.forEach(name => {
                const label = document.createElement('label');
                label.className = 'filter-item';
                label.innerHTML = `<input type="checkbox" checked onchange="toggleStream('${name}', this.checked)"> ${name}`;
                container.appendChild(label);
            });
        }

        // 2. XỬ LÝ LỌC STREAM
        function toggleStream(name, isChecked) {
            if (isChecked) {
                if (!activeStreams.includes(name)) activeStreams.push(name);
            } else {
                activeStreams = activeStreams.filter(s => s !== name);
            }
            // Sắp xếp lại theo thứ tự gốc
            activeStreams.sort((a, b) => MASTER_LIST.indexOf(a) - MASTER_LIST.indexOf(b));
            renderGrid();
        }

        function toggleFilterMenu() {
            const menu = document.getElementById('filter-modal');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            document.getElementById('btn-filter').classList.toggle('active');
        }

        // 3. RENDER LƯỚI
        function renderGrid() {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '';
            
            // Dọn dẹp HLS cũ để giải phóng RAM
            Object.values(hlsInstances).forEach(h => h.destroy());
            hlsInstances = {};

            // Chỉ render những cam được chọn
            const displayList = activeStreams.slice(0, currentLayout); // Cắt theo layout

            displayList.forEach(name => {
                const div = document.createElement('div');
                div.className = 'cam-box';
                div.innerHTML = `
                    <div class="cam-label">${name.toUpperCase()}</div>
                    
                    <div class="error-overlay" id="err-${name}">
                        <div class="error-text">
                            <i class="fas fa-exclamation-triangle" style="font-size:20px"></i><br>
                            MẤT TÍN HIỆU<br>(Stopped)
                        </div>
                        <button class="btn-retry" onclick="retryStream('${name}')">Kết nối lại</button>
                    </div>

                    <video id="vid-${name}" controls muted playsinline></video>
                `;
                grid.appendChild(div);
                loadStream(name);
            });
        }

        // 4. LOAD STREAM VỚI CƠ CHẾ "KILL-SWITCH"
        function loadStream(name) {
            const video = document.getElementById(`vid-${name}`);
            const errorOverlay = document.getElementById(`err-${name}`);
            const url = `${SERVER_HOST}/hls/${name}/index.m3u8`;

            // Ẩn lỗi trước khi load
            errorOverlay.style.display = 'none';
            retryCounts[name] = 0;

            if (Hls.isSupported()) {
                const hls = new Hls({
                    capLevelToPlayerSize: true, // Tự động tối ưu theo kích thước ô
                    maxBufferLength: 30, // Ổn định
                });
                
                hls.loadSource(url);
                hls.attachMedia(video);
                hlsInstances[name] = hls;

                // Xử lý chất lượng (nếu user đã chọn)
                applyQuality(hls);

                // QUAN TRỌNG: XỬ LÝ LỖI
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        // Nếu lỗi 404 (Không tìm thấy luồng)
                        if (data.response && data.response.code === 404) {
                            handleFatalError(name, hls, "Luồng không tồn tại (404)");
                        } 
                        // Các lỗi mạng khác
                        else if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            retryCounts[name]++;
                            console.log(`${name}: Network error retry ${retryCounts[name]}/3`);
                            
                            // Nếu lỗi quá 3 lần -> DỪNG LOAD
                            if (retryCounts[name] >= 3) {
                                handleFatalError(name, hls, "Mất kết nối quá lâu");
                            } else {
                                hls.startLoad(); // Thử lại
                            }
                        } else {
                            hls.destroy();
                        }
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari Native
                video.src = url;
                video.onerror = () => {
                    handleFatalError(name, null, "Safari Error");
                };
            }
            
            video.play().catch(()=>{});
        }

        // Hàm dừng vĩnh viễn khi lỗi
        function handleFatalError(name, hlsInstance, reason) {
            console.warn(`STOPPING STREAM: ${name} due to ${reason}`);
            
            // 1. Hủy instance HLS để ngắt kết nối mạng
            if (hlsInstance) hlsInstance.destroy();
            
            // 2. Hiện màn hình lỗi
            const errDiv = document.getElementById(`err-${name}`);
            if (errDiv) errDiv.style.display = 'flex';
        }

        // Hàm thử lại thủ công
        function retryStream(name) {
            loadStream(name);
        }

        // 5. XỬ LÝ CHẤT LƯỢNG (RESOLUTION)
        function changeQuality(val) {
            preferredHeight = parseInt(val);
            // Cập nhật tất cả các luồng đang chạy
            Object.values(hlsInstances).forEach(hls => applyQuality(hls));
        }

        function applyQuality(hls) {
            if (!hls || preferredHeight === -1) {
                if(hls) hls.currentLevel = -1; // Auto
                return;
            }

            // Tìm level phù hợp nhất
            // Lưu ý: Chỉ hoạt động nếu file m3u8 có chứa nhiều độ phân giải (Multi-bitrate)
            // Nếu không có, nó sẽ giữ nguyên luồng gốc.
            let bestLevel = -1;
            if (hls.levels && hls.levels.length > 0) {
                hls.levels.forEach((level, index) => {
                    if (level.height <= preferredHeight) {
                        bestLevel = index; // Chọn cái nhỏ hơn hoặc bằng
                    }
                });
                // Nếu không tìm thấy cái nhỏ hơn, lấy cái thấp nhất
                if (bestLevel === -1) bestLevel = 0;
                
                hls.currentLevel = bestLevel;
                console.log(`Set quality to Level ${bestLevel}`);
            }
        }

        // 6. LAYOUT
        function setLayout(n) {
            currentLayout = n;
            document.getElementById('video-grid').className = `layout-${n === 4 ? '2x2' : n === 9 ? '3x3' : '4x4'}`;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${n === 4 ? '2x2' : n === 9 ? '3x3' : '4x4'}`).classList.add('active');
            renderGrid();
        }

    </script>
</body>
</html>
